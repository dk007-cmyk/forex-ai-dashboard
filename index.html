<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD/JPY AI Sentiment Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', 'sans-serif'; }
        .sentiment-bullish { background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); border-color: #90cdf4; color: #2b6cb0; }
        .sentiment-bearish { background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border-color: #feb2b2; color: #c53030; }
        .sentiment-neutral { background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-color: #e2e8f0; color: #4a5568; }
        .stat-card { transition: transform 0.2s ease; border-width: 1px; }
        .stat-card:hover { transform: translateY(-3px); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tf-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        .live-dot { width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; display: inline-block; margin-right: 6px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-2xl shadow-lg shadow-indigo-100">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Market Momentum AI</h1>
                    <div class="flex items-center mt-1">
                        <span id="liveStatus" class="live-dot hidden"></span>
                        <p id="statusText" class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Ready to Analyze</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <input type="password" id="apiKey" placeholder="Gemini API Key" class="px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm transition-all">
                <div class="flex gap-2">
                    <button onclick="toggleAutoMode()" id="autoBtn" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl font-bold text-sm transition-all hover:bg-slate-50 active:scale-95">
                        自動更新: OFF
                    </button>
                    <button onclick="runAnalysis()" id="runBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl font-bold shadow-md shadow-indigo-100 transition-all whitespace-nowrap active:scale-95">
                        即時分析
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3 space-y-6">
                <!-- AI Sentiment Chart -->
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h2 class="font-bold text-slate-700 flex items-center gap-2">
                                AI センチメント・モメンタム推移
                                <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-400 uppercase tracking-tighter" id="chartTimeframeLabel">1H Analysis</span>
                            </h2>
                        </div>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button onclick="updateChartTimeframe('1h')" id="tf-1h" class="tf-btn active px-4 py-1.5 text-[10px] font-bold rounded-lg transition-all">1H</button>
                            <button onclick="updateChartTimeframe('4h')" id="tf-4h" class="tf-btn px-4 py-1.5 text-[10px] font-bold rounded-lg transition-all">4H</button>
                            <button onclick="updateChartTimeframe('1d')" id="tf-1d" class="tf-btn px-4 py-1.5 text-[10px] font-bold rounded-lg transition-all">1D</button>
                        </div>
                    </div>
                    <div class="h-[400px] w-full">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 stat-card">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Current Price</p>
                        <h3 id="currentPrice" class="text-3xl font-bold text-slate-800 tracking-tighter">---.--</h3>
                        <p id="priceChange" class="text-[10px] mt-2 text-slate-400 font-bold uppercase tracking-tighter italic tracking-widest">Live Fetching...</p>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 stat-card">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Market Bias</p>
                        <div id="biasIndicator" class="text-xl font-black italic uppercase text-slate-300 mt-2">Neutral</div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-4 overflow-hidden flex">
                            <div id="bullBar" class="bg-blue-400 h-full transition-all duration-1000" style="width: 50%"></div>
                            <div id="bearBar" class="bg-red-400 h-full transition-all duration-1000" style="width: 50%"></div>
                        </div>
                    </div>
                    <div id="sentimentCard" class="p-6 rounded-3xl shadow-sm border border-slate-100 stat-card flex flex-col justify-center">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">AI Recommendation</p>
                        <h3 id="verdictText" class="text-2xl font-black italic uppercase">Ready</h3>
                        <p id="nextUpdateTimer" class="text-[10px] mt-2 font-bold uppercase opacity-70 italic tracking-tighter">Waiting for start</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 h-full flex flex-col">
                    <h2 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <span class="p-1.5 bg-indigo-50 rounded-lg text-indigo-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </span>
                        モメンタム概況 (News & SNS)
                    </h2>
                    <div id="momentumSummary" class="mb-6">
                        <p class="text-[10px] text-slate-400 leading-relaxed italic p-4 border border-dashed border-slate-200 rounded-2xl text-center tracking-tighter">分析が実行されると、ニュースとSNSの統合的な要約が表示されます</p>
                    </div>
                    <div class="flex-grow overflow-y-auto max-h-[600px] pr-2 custom-scrollbar space-y-3" id="factorList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sentimentChart;
        const API_KEY_STORAGE_KEY = 'usd_jpy_gemini_key_v8_sns';
        let currentTimeframe = '1h';
        let isAutoMode = false;
        let autoInterval;
        let countdownInterval;
        let lastPrice = 155.000;
        
        const sentimentData = {
            '1h': { bull: [45, 48, 52, 50, 48, 55, 60, 58], bear: [55, 52, 48, 50, 52, 45, 40, 42] },
            '4h': { bull: [40, 42, 45, 43, 40, 38, 35, 30], bear: [60, 58, 55, 57, 60, 62, 65, 70] },
            '1d': { bull: [50, 51, 52, 50, 49, 50, 51, 52], bear: [50, 49, 48, 50, 51, 50, 49, 48] }
        };

        window.onload = async () => {
            const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            
            initSentimentChart();
            await updatePrice();
            setInterval(updatePrice, 10000);
        };

        async function updatePrice() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                const jpy = data.rates.JPY;
                lastPrice = jpy;
                document.getElementById('currentPrice').innerText = jpy.toFixed(3);
                document.getElementById('priceChange').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error("Price fetch failed");
            }
        }

        function getLabelsForTimeframe(tf) {
            const unit = tf === '1h' ? '時間前' : (tf === '4h' ? '時間前' : '日前');
            const step = tf === '4h' ? 4 : 1;
            return Array.from({length: 8}, (_, i) => {
                const val = (7 - i) * step;
                return val === 0 ? '現在' : `${val}${unit}`;
            });
        }

        function initSentimentChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: getLabelsForTimeframe(currentTimeframe),
                    datasets: [
                        {
                            label: 'Buy Strength',
                            data: [...sentimentData[currentTimeframe].bull],
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 4,
                            fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6
                        },
                        {
                            label: 'Sell Strength',
                            data: [...sentimentData[currentTimeframe].bear],
                            borderColor: '#f87171',
                            backgroundColor: 'rgba(248, 113, 113, 0.1)',
                            borderWidth: 4,
                            fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top', align: 'end', labels: { boxWidth: 12, usePointStyle: true, font: { weight: 'bold' } } },
                        tooltip: { backgroundColor: '#1e293b', padding: 12, titleFont: { size: 14 } }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' }, ticks: { font: { size: 11 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 11 } } }
                    }
                }
            });
        }

        function updateChartTimeframe(tf) {
            currentTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tf-${tf}`).classList.add('active');
            document.getElementById('chartTimeframeLabel').innerText = `${tf.toUpperCase()} Analysis`;

            sentimentChart.data.labels = getLabelsForTimeframe(tf);
            sentimentChart.data.datasets[0].data = [...sentimentData[tf].bull];
            sentimentChart.data.datasets[1].data = [...sentimentData[tf].bear];
            sentimentChart.update();
        }

        function toggleAutoMode() {
            const key = document.getElementById('apiKey').value;
            if (!key) return alert("APIキーを入力してください");

            isAutoMode = !isAutoMode;
            const btn = document.getElementById('autoBtn');
            const statusDot = document.getElementById('liveStatus');
            const statusText = document.getElementById('statusText');

            if (isAutoMode) {
                btn.innerText = "自動更新: ON";
                btn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
                statusDot.classList.remove('hidden');
                statusText.innerText = "Monitoring Live Flows";
                runAnalysis();
                startCountdown();
                autoInterval = setInterval(runAnalysis, 300000);
            } else {
                btn.innerText = "自動更新: OFF";
                btn.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
                statusDot.classList.add('hidden');
                statusText.innerText = "Ready to Analyze";
                clearInterval(autoInterval);
                clearInterval(countdownInterval);
                document.getElementById('nextUpdateTimer').innerText = "Auto Mode Paused";
            }
        }

        function startCountdown() {
            clearInterval(countdownInterval);
            let timeLeft = 300;
            const timerDisplay = document.getElementById('nextUpdateTimer');
            countdownInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerDisplay.innerText = `Next AI Check: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
                if (timeLeft <= 0) timeLeft = 300;
            }, 1000);
        }

        async function fetchNewsSafe() {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://news.google.com/rss/search?q=USD+JPY+forex&hl=ja&gl=JP&ceid=JP:ja`)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const parser = new DOMParser();
                const xml = parser.parseFromString(data.contents, "text/xml");
                const items = Array.from(xml.querySelectorAll("item")).slice(0, 5);
                return items.map(i => i.querySelector("title").textContent);
            } catch (e) {
                return ["為替介入への警戒感", "米金利見通しの修正", "ドルの底堅い推移"];
            }
        }

        // 仮想的なSNSデータ生成（実API連携の代わり）
        function getMockSNSData() {
            const posts = [
                "155円突破！このまま160円まで行くのでは？ #USDJPY #円安",
                "介入が怖くて手が出せない。ショート勢が焼かれてる。",
                "米雇用統計待ちで膠着状態。上値は重い気がする。",
                "Reddit: USD looks unstoppable, JPY carry trade is back.",
                "ドル円の調整売りがそろそろ来そう。"
            ];
            // ランダムに3つピックアップ
            return posts.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        async function runAnalysis() {
            const key = document.getElementById('apiKey').value;
            if (!key) return;
            localStorage.setItem(API_KEY_STORAGE_KEY, key);
            const btn = document.getElementById('runBtn');
            if (!isAutoMode) btn.innerText = "分析中...";
            
            try {
                const headlines = await fetchNewsSafe();
                const snsPosts = getMockSNSData();
                
                const prompt = `分析対象: USD/JPY, 時間軸: ${currentTimeframe}. 
価格: ${lastPrice}.
【ニュース】: ${headlines.join('/')}
【SNS投稿】: ${snsPosts.join('/')}
任務: ニュースの客観的情報と、SNSの主観的・感情的な情報を統合し分析せよ。
JSON形式で回答: {bull_strength:0-100, bear_strength:0-100, bias:BULLISH/BEARISH/NEUTRAL, verdict:BUY/SELL/HOLD, summary:ニュースとSNSを考慮した100字要約, factors:[{name:要因, impact:BUY/SELL, desc:説明(SNS由来の場合はその旨明記)}]}`;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const result = await res.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);

                // チャート更新
                sentimentData[currentTimeframe].bull.shift();
                sentimentData[currentTimeframe].bull.push(data.bull_strength);
                sentimentData[currentTimeframe].bear.shift();
                sentimentData[currentTimeframe].bear.push(data.bear_strength);
                
                sentimentChart.data.datasets[0].data = [...sentimentData[currentTimeframe].bull];
                sentimentChart.data.datasets[1].data = [...sentimentData[currentTimeframe].bear];
                sentimentChart.update();

                // UI表示更新
                document.getElementById('biasIndicator').innerText = data.bias;
                document.getElementById('biasIndicator').className = `text-xl font-black italic uppercase mt-2 ${data.bias === 'BULLISH' ? 'text-blue-500' : data.bias === 'BEARISH' ? 'text-red-500' : 'text-slate-400'}`;
                document.getElementById('bullBar').style.width = `${data.bull_strength}%`;
                document.getElementById('bearBar').style.width = `${data.bear_strength}%`;
                document.getElementById('verdictText').innerText = data.verdict;
                
                const card = document.getElementById('sentimentCard');
                card.className = `p-6 rounded-3xl shadow-sm border border-slate-100 stat-card flex flex-col justify-center ${data.verdict === 'BUY' ? 'sentiment-bullish' : data.verdict === 'SELL' ? 'sentiment-bearish' : 'sentiment-neutral'}`;

                document.getElementById('momentumSummary').innerHTML = `<div class="p-4 bg-white/50 rounded-2xl text-[11px] leading-relaxed text-slate-600 border border-slate-100 shadow-inner">${data.summary}</div>`;

                const factorList = document.getElementById('factorList');
                factorList.innerHTML = '';
                data.factors.forEach(f => {
                    const div = document.createElement('div');
                    div.className = "p-3 bg-slate-50 rounded-2xl border border-slate-100";
                    div.innerHTML = `<div class="flex justify-between mb-1"><span class="text-[10px] font-bold">${f.name}</span><span class="text-[8px] font-black px-1.5 py-0.5 rounded ${f.impact === 'BUY' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}">${f.impact}</span></div><p class="text-[9px] text-slate-500">${f.desc}</p>`;
                    factorList.appendChild(div);
                });

                if (isAutoMode) startCountdown();
            } catch (e) { console.error(e); } finally { if (!isAutoMode) btn.innerText = "即時分析"; }
        }
    </script>
</body>
</html>